var RadarDispatcher = require('../dispatchers/RadarDispatcher');
var EventEmitter = require('event-emitter'); // node.jsのeventsを使用しないこと。Nashornでは使用できない
var Constants = require('../Constants');
var merge = require('react/lib/merge');
var async = require('async');
var Colr = require('colr');

var _selectedOss, _positionCache = {}, _colorCache = {};

// Dotの中心からの距離を計算する
function calcDistance(x, y, minimumDistanceSquare, coords) {
  var ret = -1;
  var min = Number.MAX_VALUE;
  var length = coords.length;
  if (length === 0)
    return -1;

  for (var i = 0; i < length; i++) {
    var cx = coords[i].cx;
    var cy = coords[i].cy;
    var d = Math.pow(cx - x, 2) + Math.pow(cy - y, 2);
    if (d < minimumDistanceSquare) {
      if (d < min) {
        ret = min = d;
      }
    }
  }
  return ret;
}

// displayNameがcategoriesの中の何番目のデータなのか取得する
function findCategoryIndex(categories, displayName) {
  for (var i = 0, len = categories.length; i < len; i++) {
    if (categories[i].displayName === displayName) return i;
  }
  return -1;
}
// Dotの表示場所を計算する
function calcDotPosition(url, yearMonth, ranking, categories, isChildCategory) {
  if (_positionCache[url]) return _positionCache[url];
  var categoryAngle = 2 * Math.PI / categories.length;
  var fullScore = 5;
  var coords = [];
  var minimumDistanceSquare = Math.pow(2 * 8, 2) * (Math.random() + 1.5);
  var dx, dy, categoryIndex;
  var colorTable = makeColorTable(ranking, categories);
  var positions = ranking.map(function(product, index) {
    var distance = Constants.RADER_RADIUS / 4 * (fullScore - product.score);
    if (isChildCategory) {
      categoryIndex = findCategoryIndex(categories, product.childCategory.displayName);
    } else {
      categoryIndex = findCategoryIndex(categories, product.category.displayName);
    }
    var maxDistance = 0;
    for (var i = 0; i < 100; i++) {
      var theta = Math.random() * categoryAngle * 0.8 + categoryAngle * categoryIndex + categoryAngle * 0.1;
      // 0.8を掛けているのは角度の深い方の境界線に被らないようにするため
      // 0.1を掛けて足しているのも角度の浅い方の境界線に被らないようにするため

      // 角度から座標を取得
      var x = Math.round(Constants.RADER_CENTER_X + distance * Math.sin(theta));
      var y = Math.round(Constants.RADER_CENTER_Y - distance * Math.cos(theta));

      var ret = calcDistance(x, y, minimumDistanceSquare, coords);
      if (ret == -1) {
        dx = x;
        dy = y;
        maxDistance = 0;
        break;
      } else if (ret > maxDistance) {
        dx = x;
        dy = y;
        maxDistance = ret;
      }
    }
    coords.push({cx: dx, cy: dy});
    return {
      num: index + 1,
      product: product,
      color: colorTable[product.category.displayName][product.childCategory.displayName],
      x: dx,
      y: dy
    };
  });
  _positionCache[url] = positions; // 一度計算したポジションはキャッシュする
  return positions;
}

function countChildCategories(ranking) {
  var counter = 0;
  var categoryInfo = getCategoryInfo(ranking);
  for (var cname in categoryInfo) {
    for (var gname in categoryInfo[cname]) {
      counter++;
    }
  }
  return counter;
}
function getCategoryInfo(ranking) {
  var info = {};
  ranking.forEach(function(p) {
    var cname = p.category.displayName;
    if (!info[cname]) info[cname] = {};
    var gname = p.childCategory.displayName;
    if (!info[cname][gname]) info[cname][gname] = true;
  });
  return info;
}

function makeColorTable(ranking, categories) {
  var cacheKey= categories.join('')
  if (_colorCache[cacheKey]) return _colorCache[cacheKey];
  var hsvDelta = Math.round(360 / countChildCategories(ranking));
  var colorTable = {};
  var categoryInfo = getCategoryInfo(ranking);
  var counter = 0;
  for (var cname in categoryInfo) {
    colorTable[cname] = {};
    for (var gname in categoryInfo[cname]) {
      var color = Colr.fromHsv(hsvDelta * counter++, 80, 80).toHex();
      colorTable[cname][gname] = color
    }
  }
  _colorCache[cacheKey] = colorTable;
  return colorTable;
}

var RadarStore = EventEmitter({
  getSelectedOss: function() { return _selectedOss; },
  calcDotPosition: calcDotPosition,
  emitChange: function() {
    this.emit(Constants.RADAR_STORE_CHANGE);
  },
  addStoreChangeListener: function(callback) {
    this.on(Constants.RADAR_STORE_CHANGE, callback);
  },
  removeStoreChangeListener: function(callback) {
    this.off(Constants.RADAR_STORE_CHANGE, callback);
  }
});

RadarDispatcher.register(function(payload) {
  switch(payload.actionType) {
    case Constants.UPDATE_SELECTED_OSS:
      _selectedOss = parseInt(payload.ossId, 10);
      RadarStore.emitChange();
      break;
    default:
      return true;
  }
  return true; // No errors.  Needed by promise in Dispatcher.
});

module.exports = RadarStore;

//# sourceMappingURL=data:application/json;base64,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QUM7R0FDZjtFQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQyxDQUFDLENBQUM7O0FBRUgsTUFBTSxDQUFDLE9BQU8sR0FBRyxVQUFVLENBQUMiLCJmaWxlIjoic3RvcmVzL1JhZGFyU3RvcmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgUmFkYXJEaXNwYXRjaGVyID0gcmVxdWlyZSgnLi4vZGlzcGF0Y2hlcnMvUmFkYXJEaXNwYXRjaGVyJyk7XG52YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnQtZW1pdHRlcicpOyAvLyBub2RlLmpz44GuZXZlbnRz44KS5L2/55So44GX44Gq44GE44GT44Go44CCTmFzaG9ybuOBp+OBr+S9v+eUqOOBp+OBjeOBquOBhFxudmFyIENvbnN0YW50cyA9IHJlcXVpcmUoJy4uL0NvbnN0YW50cycpO1xudmFyIG1lcmdlID0gcmVxdWlyZSgncmVhY3QvbGliL21lcmdlJyk7XG52YXIgYXN5bmMgPSByZXF1aXJlKCdhc3luYycpO1xudmFyIENvbHIgPSByZXF1aXJlKCdjb2xyJyk7XG5cbnZhciBfc2VsZWN0ZWRPc3MsIF9wb3NpdGlvbkNhY2hlID0ge30sIF9jb2xvckNhY2hlID0ge307XG5cbi8vIERvdOOBruS4reW/g+OBi+OCieOBrui3nembouOCkuioiOeul+OBmeOCi1xuZnVuY3Rpb24gY2FsY0Rpc3RhbmNlKHgsIHksIG1pbmltdW1EaXN0YW5jZVNxdWFyZSwgY29vcmRzKSB7XG4gIHZhciByZXQgPSAtMTtcbiAgdmFyIG1pbiA9IE51bWJlci5NQVhfVkFMVUU7XG4gIHZhciBsZW5ndGggPSBjb29yZHMubGVuZ3RoO1xuICBpZiAobGVuZ3RoID09PSAwKVxuICAgIHJldHVybiAtMTtcblxuICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgdmFyIGN4ID0gY29vcmRzW2ldLmN4O1xuICAgIHZhciBjeSA9IGNvb3Jkc1tpXS5jeTtcbiAgICB2YXIgZCA9IE1hdGgucG93KGN4IC0geCwgMikgKyBNYXRoLnBvdyhjeSAtIHksIDIpO1xuICAgIGlmIChkIDwgbWluaW11bURpc3RhbmNlU3F1YXJlKSB7XG4gICAgICBpZiAoZCA8IG1pbikge1xuICAgICAgICByZXQgPSBtaW4gPSBkO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gcmV0O1xufVxuXG4vLyBkaXNwbGF5TmFtZeOBjGNhdGVnb3JpZXPjga7kuK3jga7kvZXnlarnm67jga7jg4fjg7zjgr/jgarjga7jgYvlj5blvpfjgZnjgotcbmZ1bmN0aW9uIGZpbmRDYXRlZ29yeUluZGV4KGNhdGVnb3JpZXMsIGRpc3BsYXlOYW1lKSB7XG4gIGZvciAodmFyIGkgPSAwLCBsZW4gPSBjYXRlZ29yaWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgaWYgKGNhdGVnb3JpZXNbaV0uZGlzcGxheU5hbWUgPT09IGRpc3BsYXlOYW1lKSByZXR1cm4gaTtcbiAgfVxuICByZXR1cm4gLTE7XG59XG4vLyBEb3Tjga7ooajnpLrloLTmiYDjgpLoqIjnrpfjgZnjgotcbmZ1bmN0aW9uIGNhbGNEb3RQb3NpdGlvbih1cmwsIHllYXJNb250aCwgcmFua2luZywgY2F0ZWdvcmllcywgaXNDaGlsZENhdGVnb3J5KSB7XG4gIGlmIChfcG9zaXRpb25DYWNoZVt1cmxdKSByZXR1cm4gX3Bvc2l0aW9uQ2FjaGVbdXJsXTtcbiAgdmFyIGNhdGVnb3J5QW5nbGUgPSAyICogTWF0aC5QSSAvIGNhdGVnb3JpZXMubGVuZ3RoO1xuICB2YXIgZnVsbFNjb3JlID0gNTtcbiAgdmFyIGNvb3JkcyA9IFtdO1xuICB2YXIgbWluaW11bURpc3RhbmNlU3F1YXJlID0gTWF0aC5wb3coMiAqIDgsIDIpICogKE1hdGgucmFuZG9tKCkgKyAxLjUpO1xuICB2YXIgZHgsIGR5LCBjYXRlZ29yeUluZGV4O1xuICB2YXIgY29sb3JUYWJsZSA9IG1ha2VDb2xvclRhYmxlKHJhbmtpbmcsIGNhdGVnb3JpZXMpO1xuICB2YXIgcG9zaXRpb25zID0gcmFua2luZy5tYXAoZnVuY3Rpb24ocHJvZHVjdCwgaW5kZXgpIHtcbiAgICB2YXIgZGlzdGFuY2UgPSBDb25zdGFudHMuUkFERVJfUkFESVVTIC8gNCAqIChmdWxsU2NvcmUgLSBwcm9kdWN0LnNjb3JlKTtcbiAgICBpZiAoaXNDaGlsZENhdGVnb3J5KSB7XG4gICAgICBjYXRlZ29yeUluZGV4ID0gZmluZENhdGVnb3J5SW5kZXgoY2F0ZWdvcmllcywgcHJvZHVjdC5jaGlsZENhdGVnb3J5LmRpc3BsYXlOYW1lKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY2F0ZWdvcnlJbmRleCA9IGZpbmRDYXRlZ29yeUluZGV4KGNhdGVnb3JpZXMsIHByb2R1Y3QuY2F0ZWdvcnkuZGlzcGxheU5hbWUpO1xuICAgIH1cbiAgICB2YXIgbWF4RGlzdGFuY2UgPSAwO1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMTAwOyBpKyspIHtcbiAgICAgIHZhciB0aGV0YSA9IE1hdGgucmFuZG9tKCkgKiBjYXRlZ29yeUFuZ2xlICogMC44ICsgY2F0ZWdvcnlBbmdsZSAqIGNhdGVnb3J5SW5kZXggKyBjYXRlZ29yeUFuZ2xlICogMC4xO1xuICAgICAgLy8gMC4444KS5o6b44GR44Gm44GE44KL44Gu44Gv6KeS5bqm44Gu5rex44GE5pa544Gu5aKD55WM57ea44Gr6KKr44KJ44Gq44GE44KI44GG44Gr44GZ44KL44Gf44KBXG4gICAgICAvLyAwLjHjgpLmjpvjgZHjgabotrPjgZfjgabjgYTjgovjga7jgoLop5Lluqbjga7mtYXjgYTmlrnjga7looPnlYznt5rjgavooqvjgonjgarjgYTjgojjgYbjgavjgZnjgovjgZ/jgoFcblxuICAgICAgLy8g6KeS5bqm44GL44KJ5bqn5qiZ44KS5Y+W5b6XXG4gICAgICB2YXIgeCA9IE1hdGgucm91bmQoQ29uc3RhbnRzLlJBREVSX0NFTlRFUl9YICsgZGlzdGFuY2UgKiBNYXRoLnNpbih0aGV0YSkpO1xuICAgICAgdmFyIHkgPSBNYXRoLnJvdW5kKENvbnN0YW50cy5SQURFUl9DRU5URVJfWSAtIGRpc3RhbmNlICogTWF0aC5jb3ModGhldGEpKTtcblxuICAgICAgdmFyIHJldCA9IGNhbGNEaXN0YW5jZSh4LCB5LCBtaW5pbXVtRGlzdGFuY2VTcXVhcmUsIGNvb3Jkcyk7XG4gICAgICBpZiAocmV0ID09IC0xKSB7XG4gICAgICAgIGR4ID0geDtcbiAgICAgICAgZHkgPSB5O1xuICAgICAgICBtYXhEaXN0YW5jZSA9IDA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfSBlbHNlIGlmIChyZXQgPiBtYXhEaXN0YW5jZSkge1xuICAgICAgICBkeCA9IHg7XG4gICAgICAgIGR5ID0geTtcbiAgICAgICAgbWF4RGlzdGFuY2UgPSByZXQ7XG4gICAgICB9XG4gICAgfVxuICAgIGNvb3Jkcy5wdXNoKHtjeDogZHgsIGN5OiBkeX0pO1xuICAgIHJldHVybiB7XG4gICAgICBudW06IGluZGV4ICsgMSxcbiAgICAgIHByb2R1Y3Q6IHByb2R1Y3QsXG4gICAgICBjb2xvcjogY29sb3JUYWJsZVtwcm9kdWN0LmNhdGVnb3J5LmRpc3BsYXlOYW1lXVtwcm9kdWN0LmNoaWxkQ2F0ZWdvcnkuZGlzcGxheU5hbWVdLFxuICAgICAgeDogZHgsXG4gICAgICB5OiBkeVxuICAgIH07XG4gIH0pO1xuICBfcG9zaXRpb25DYWNoZVt1cmxdID0gcG9zaXRpb25zOyAvLyDkuIDluqboqIjnrpfjgZfjgZ/jg53jgrjjgrfjg6fjg7Pjga/jgq3jg6Pjg4Pjgrfjg6XjgZnjgotcbiAgcmV0dXJuIHBvc2l0aW9ucztcbn1cblxuZnVuY3Rpb24gY291bnRDaGlsZENhdGVnb3JpZXMocmFua2luZykge1xuICB2YXIgY291bnRlciA9IDA7XG4gIHZhciBjYXRlZ29yeUluZm8gPSBnZXRDYXRlZ29yeUluZm8ocmFua2luZyk7XG4gIGZvciAodmFyIGNuYW1lIGluIGNhdGVnb3J5SW5mbykge1xuICAgIGZvciAodmFyIGduYW1lIGluIGNhdGVnb3J5SW5mb1tjbmFtZV0pIHtcbiAgICAgIGNvdW50ZXIrKztcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGNvdW50ZXI7XG59XG5mdW5jdGlvbiBnZXRDYXRlZ29yeUluZm8ocmFua2luZykge1xuICB2YXIgaW5mbyA9IHt9O1xuICByYW5raW5nLmZvckVhY2goZnVuY3Rpb24ocCkge1xuICAgIHZhciBjbmFtZSA9IHAuY2F0ZWdvcnkuZGlzcGxheU5hbWU7XG4gICAgaWYgKCFpbmZvW2NuYW1lXSkgaW5mb1tjbmFtZV0gPSB7fTtcbiAgICB2YXIgZ25hbWUgPSBwLmNoaWxkQ2F0ZWdvcnkuZGlzcGxheU5hbWU7XG4gICAgaWYgKCFpbmZvW2NuYW1lXVtnbmFtZV0pIGluZm9bY25hbWVdW2duYW1lXSA9IHRydWU7XG4gIH0pO1xuICByZXR1cm4gaW5mbztcbn1cblxuZnVuY3Rpb24gbWFrZUNvbG9yVGFibGUocmFua2luZywgY2F0ZWdvcmllcykge1xuICB2YXIgY2FjaGVLZXk9IGNhdGVnb3JpZXMuam9pbignJylcbiAgaWYgKF9jb2xvckNhY2hlW2NhY2hlS2V5XSkgcmV0dXJuIF9jb2xvckNhY2hlW2NhY2hlS2V5XTtcbiAgdmFyIGhzdkRlbHRhID0gTWF0aC5yb3VuZCgzNjAgLyBjb3VudENoaWxkQ2F0ZWdvcmllcyhyYW5raW5nKSk7XG4gIHZhciBjb2xvclRhYmxlID0ge307XG4gIHZhciBjYXRlZ29yeUluZm8gPSBnZXRDYXRlZ29yeUluZm8ocmFua2luZyk7XG4gIHZhciBjb3VudGVyID0gMDtcbiAgZm9yICh2YXIgY25hbWUgaW4gY2F0ZWdvcnlJbmZvKSB7XG4gICAgY29sb3JUYWJsZVtjbmFtZV0gPSB7fTtcbiAgICBmb3IgKHZhciBnbmFtZSBpbiBjYXRlZ29yeUluZm9bY25hbWVdKSB7XG4gICAgICB2YXIgY29sb3IgPSBDb2xyLmZyb21Ic3YoaHN2RGVsdGEgKiBjb3VudGVyKyssIDgwLCA4MCkudG9IZXgoKTtcbiAgICAgIGNvbG9yVGFibGVbY25hbWVdW2duYW1lXSA9IGNvbG9yXG4gICAgfVxuICB9XG4gIF9jb2xvckNhY2hlW2NhY2hlS2V5XSA9IGNvbG9yVGFibGU7XG4gIHJldHVybiBjb2xvclRhYmxlO1xufVxuXG52YXIgUmFkYXJTdG9yZSA9IEV2ZW50RW1pdHRlcih7XG4gIGdldFNlbGVjdGVkT3NzOiBmdW5jdGlvbigpIHsgcmV0dXJuIF9zZWxlY3RlZE9zczsgfSxcbiAgY2FsY0RvdFBvc2l0aW9uOiBjYWxjRG90UG9zaXRpb24sXG4gIGVtaXRDaGFuZ2U6IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZW1pdChDb25zdGFudHMuUkFEQVJfU1RPUkVfQ0hBTkdFKTtcbiAgfSxcbiAgYWRkU3RvcmVDaGFuZ2VMaXN0ZW5lcjogZnVuY3Rpb24oY2FsbGJhY2spIHtcbiAgICB0aGlzLm9uKENvbnN0YW50cy5SQURBUl9TVE9SRV9DSEFOR0UsIGNhbGxiYWNrKTtcbiAgfSxcbiAgcmVtb3ZlU3RvcmVDaGFuZ2VMaXN0ZW5lcjogZnVuY3Rpb24oY2FsbGJhY2spIHtcbiAgICB0aGlzLm9mZihDb25zdGFudHMuUkFEQVJfU1RPUkVfQ0hBTkdFLCBjYWxsYmFjayk7XG4gIH1cbn0pO1xuXG5SYWRhckRpc3BhdGNoZXIucmVnaXN0ZXIoZnVuY3Rpb24ocGF5bG9hZCkge1xuICBzd2l0Y2gocGF5bG9hZC5hY3Rpb25UeXBlKSB7XG4gICAgY2FzZSBDb25zdGFudHMuVVBEQVRFX1NFTEVDVEVEX09TUzpcbiAgICAgIF9zZWxlY3RlZE9zcyA9IHBhcnNlSW50KHBheWxvYWQub3NzSWQsIDEwKTtcbiAgICAgIFJhZGFyU3RvcmUuZW1pdENoYW5nZSgpO1xuICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHJldHVybiB0cnVlOyAvLyBObyBlcnJvcnMuICBOZWVkZWQgYnkgcHJvbWlzZSBpbiBEaXNwYXRjaGVyLlxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gUmFkYXJTdG9yZTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==